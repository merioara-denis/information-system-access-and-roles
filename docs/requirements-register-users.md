# Регистрация пользователей

[< Вернуться](./README.md)

## Нарратив

**Я как** пользователь **Хочу** создать учётную запись **Чтобы** получить доступ к информационной системе.

## Границы истории

Создание новой учётную запись.

## Критерии достижения

Пользователь может создать учетную запись если корректно укажет данные.

## Пользовательский путь

1. Пользователь заполняет форму регистрации (Frontend).
    - 1.1 Указывает `адрес электронной почты` _(обязательное поле)_;
    - 1.2 Указывает `номер телефона` _(обязательное поле)_;
    - 1.3 Указывает `пароль` _(обязательное поле)_;
    - 1.4 Указывает `повторно пароль` _(обязательное поле)_;
    - 1.5 Указывает `имя` для отображения _(обязательное поле)_;
2. Отправляет данные сервису.
    - 2.1 На время выполнения запроса форма переходит в режим просмотра и пользователь не может изменить или отправить форму снова пока не прейдёт ответ.
3. Сервис проводит валидацию.
    - 3.1 `адрес электронной почты` соответствует формату;
    - 3.2 Номер телефона соответствует формату;
    - 3.3 Проверяет пароль
        - 3.3.1 Поле `пароль` и повторный ввод пароля идентичны;
        - 3.3.2 Пароль соответствует формату;
    - 3.4 Поле `имя` соответствует формату;
4. Сервис проверяет если пользователи ранее регистрировались с текущим `адрес электронной почты` или `номером телефона`
    - 4.1 `адрес электронной почты` должен быть уникальным;
    - 4.1 `номер телефона` должен быть уникальным;
5. Добавляется новый пользователь

## Критерии приёмки

1. Пользователь заполняет форму регистрации (Frontend).
    - 1.1 Если в поле есть ошибки пользователю отображается иконка "информации" с подсказкой;
    - 1.2 При редактирование поле проверяется на каждое изменение;
    - 1.3 При клике на кнопку отправки проводится повторная валидация;
    - 1.4 При клике на кнопку очистки все данные очищаются и ошибки пропадают;
2. Отправляет данные сервису.
    - Если сервис недоступен (нет доступа к интернету или сервис отвалился) пользователю отображается ошибка по умолчанию. "Сервис недоступен, проверьте доступ к интернету или попробуйте позже повторить операцию";
3. Сервис проводит валидацию.
    - Если при проверки корректности введённых данных обнаружены ошибки, форма остаётся заполнена и пользователю отображаются поля с уведомлением о ошибке в рамках конкретнои валидации;
4. Сервис проверяет уникальность `адреса электронной почты` или `номера телефона`.
    - Если обнаружены уже зарегистрированные пользователи с текущими данными, пользователю возвращаться ошибка с текстом "Пользователь с таким {`адресом электронной почты` или `номером телефона`} уже зарегистрирован.";
5. Добавляется новый пользователь.
    - Если при добавлении нового пользователя возникла ошибка, пользователю возвращаться ошибка с текстом "Произошла ошибка пожалуйста, попробуйте снова или обратитесь в поддержку `support@domain.com`";
    - Адрес поддержки должен быть настраиваемым;
6. Все тексты должны быть локализуемые.

## Реализация

### Модели данных

#### RegisterUserRequest

| Поле     | Тип    | Название                |
| -------- | ------ | ----------------------- |
| Email    | String | Адрес электронной почты |
| Phone    | String | Номер телефона          |
| Password | String | Пароль                  |
| Name     | String | Имя                     |
    
##### Валидация

- Email - должен соответствовать формату `{nickname}@{domain.org}`;
- Phone - должен начинаться с кода страны в формате `+7....`;
- Password
    - Минимум 8 символов;
    - Максимум 16 символов;
    - Содержит буквы в верхнем регистре;
    - Содержит буквы в нижнем регистре;
    - Содержит цифры;
    - Содержит хотя бы один из специальных символов `%, *, ?, @, #, $, ~`;
- Name
    - Минимум 1 символ;
    - Максимум 24 символов;

### Схемы взаимодействия

##### В случаях успеха

```sequence-diagrams
Frontend->Backend: POST: /user/register (RegisterUserRequest)
note right of Backend: Реализует валидацию и регистрацию
Backend->Frontend: Response 204
```

##### В случаях ошибки валидации

```sequence-diagrams
Frontend->Backend: POST: /user/register (RegisterUserRequest)
note right of Backend: Реализует валидацию и регистрацию
Backend->Frontend: Response 400 (ApiErrorResponse)
```

##### В случаях внутренней ошибки

```sequence-diagrams
Frontend->Backend: POST: /user/register (RegisterUserRequest)
note right of Backend: Реализует валидацию и регистрацию
Backend->Frontend: Response 500 (ApiErrorResponse)
```

### Дизайн решения

```flowchart
A[UsersController::register] -->|RegisterUserRequest| B(UsersService::register)
B -->|RegisterUserRequest| C1(UsersRegisterService::validate)
B -->|RegisterUserRequest| C2(UsersRegisterService::register)
C1(UsersRegisterService::validate) -->|Boolean| B
C2(UsersRegisterService::register) -->|Boolean| B
B -->|ApiErrorResponse or Void| A
```

### Миграция данных

#### Таблица `Users`

| Поле                   | Тип     | Название                              |
| ---------------------- | ------- | ------------------------------------- |
| uid                    | Guid    | Уникальный идентификатор пользователя |
| email                  | String  | Адрес электронной почты               |
| has_confirmation_email | Boolean | Подтверждение электронной почты       |
| phone                  | String  | Номер телефона                        |
| has_confirmation_phone | Boolean | Подтверждение номера телефона         |
| password               | String  | Пароль                                |
| name                   | String  | Имя                                   |

#### Супер администратор (По умолчанию)

| Поле                   | Значение                             |
| ---------------------- | ------------------------------------ |
| uid                    | 8b82363a-1419-40e6-997a-b9b5404287f0 |
| email                  | super.admin@domain.com               |
| has_confirmation_email | TRUE                                 |
| phone                  | +0                                   |
| has_confirmation_phone | TRUE                                 |
| password               | super.admin                          |
| name                   | First Last Middle Name               |